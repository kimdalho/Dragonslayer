# 방어와 공격을 함께한다! PvP 디펜스 게임 드레곤 슬레이어
## 혼자하는 디펜스 게임 멈춰!!✋ 내가 이 장르 고수다!

<img width="150" src="https://user-images.githubusercontent.com/73621658/161711654-dd92e728-7253-4d2f-b418-745cf0355ff5.png">

<b>공식 사이트</b> : https://debate-talk.com <br/>
FrontEnd GITHUB : https://github.com/jeonhaekang/dalk_debateTalk <br />
BackEnd GITHUB : https://github.com/raddaslul/dalk.git <br />
소개 영상 : https://www.youtube.com/watch?v=0pZMK9UqOqA <br />

# 🗂 프로젝트 소개

- 개발 기간 : 2022.02.25 ~ 2022.04.08
- 개발 언어 : Javascript
- 개발 프레임워크 : React
- 배포 환경 : AWS Amplify
- 협업 툴 : Git / Notion / Figma / Slack
  <br />


<br />

# ✔ 핵심 기능

> ### 💬 밸런스 게임을 주제로 실시간 채팅

- 깻잎논쟁, 부먹or찍먹등 다양한 주제로 채팅방을 개설하세요!
- 채팅방에서 다른유저들과 함께 자신의 의견을 어필해보세요!
- 나만말하거나 상대방의 채팅을 랜덤으로 번역하는 등 다양한 아이템을 사용해서
  상대방의 어필을 방해해보세요!

  <br/>
> ### 🗳 단순 투표가 아닌 포인트를 걸고 투표

- 밸런스채팅에서 내의견을 말할 때 포인트를 걸고 투표를 할 수 있습니다.
- 채팅이 종료된 후 내가 투표한 주제가 승리했다면 상대방의 포인트와 내가 건 포인트에
  비례해서 더 많은 포인트를 획득할 수 있습니다.
- 이 주제의 승리가 확실하다면 포인트를 많이 걸어서 더 많은 포인트를 획득하세요!

  <br/>
> ### 🎰 다양한 재미적 요소(아이템 상점, 뽑기, 등급, 랭킹)

- 밸런스 게임을 이기기 위해 많은 아이템을 판매하고 있어요. (파파고, 채팅얼리기, 로꾸꺼 등)
- 토론에 져서 포인트가 없으신가요? 매일 갱신되는 뽑기를 통해 알포인트를 충전하세요.
- 토론에서 이긴 알포인트로 경험치를 구매해 등급을 올려보세요.
  TOP 1,2,3 등에게는 멋진 휘장이 부여 됩니다.

  <br/>


# 🎥 데모

<details>
    <summary>펼치기</summary>

|                                                                토론방 채팅                                                                 |                                                                밸런스 투표                                                                 |                                                                아이템 사용                                                                 |
| :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: |
| <img src="https://user-images.githubusercontent.com/96935557/161021106-6b6ca8b6-c14d-4a1b-95a9-185fca9e95fc.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161022511-85b7ba71-68b1-41f8-9089-7fbb1422a636.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161027809-a2c18e4c-7336-4119-888f-332bf22c2ca1.gif" alt="demo" width="80%" /> |

<br/>

|                                                       카테고리 별 토론, 결과방 조회                                                        |                                                             토론, 결과방 검색                                                              |                                                                결과방 통계                                                                 |
| :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: |
| <img src="https://user-images.githubusercontent.com/96935557/161029832-13ad234e-45c5-444e-bfab-b6408ab7cc9c.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161034287-29677099-4849-4580-ad30-5982073fdb97.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161034297-4519036f-4cea-45a2-9420-8cb5ff3a7f43.gif" alt="demo" width="80%" /> |

<br/>

|                                                                 전체 랭킹                                                                  |                                                               알포인트 상점                                                                |                                                               알포인트 뽑기                                                                |
| :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: |
| <img src="https://user-images.githubusercontent.com/96935557/161111439-16be1036-1328-45a1-8ca5-07102f59a2a8.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161111417-04daff13-e4ce-4281-bff5-1941992756f5.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161707106-808eaa4b-a272-4c83-a2cd-4cc278860329.gif" alt="demo" width="80%" /> |

<br/>

|                                                                 등급 안내                                                                  |                                                               댓글 등록&삭제                                                               |                                                               댓글 찬성&반대                                                               |
| :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: |
| <img src="https://user-images.githubusercontent.com/96935557/161114764-a8dbe498-c572-4114-b3e1-39233948910e.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161114761-47ad8539-9527-43c2-8623-b8235d817517.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161114755-e673d71d-c320-44ae-8244-f82c3fe17960.gif" alt="demo" width="80%" /> |

<br/>

|                                                          유저, 토론, 결과방 신고                                                           |                                                                무한 스크롤                                                                 |                                                                  공유하기                                                                  |
| :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: |
| <img src="https://user-images.githubusercontent.com/96935557/161129182-92fc399b-4ec6-428f-88be-9cda60d22d89.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161129195-77e3cdd0-0e51-4f29-9037-8590cdc769b5.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161129191-b829da82-d1cd-4dfe-9af2-2278958ea866.gif" alt="demo" width="80%" /> |

<br/>

|                                                                   온보딩                                                                   |                                                               관리자 페이지                                                                |                                                                  토론안내                                                                  |
| :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: |
| <img src="https://user-images.githubusercontent.com/96935557/161707100-14033822-ecd8-4e65-86d9-74168180d107.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161707113-d1c4ba48-35b4-42ad-93f7-7c35b75def0f.gif" alt="demo" width="80%" /> | <img src="https://user-images.githubusercontent.com/96935557/161707079-1a3e499d-f3f8-4d7f-b4bf-cdbf8ecca800.gif" alt="demo" width="80%" /> |

</details>

<br />

# 🧩 아키텍쳐

![dalkArchitecture](https://user-images.githubusercontent.com/96935557/160998932-99d23bea-c77b-4cfb-9409-f6879eef7f4c.PNG)

<br />

# 🔨 기술 스택

 <div align="center">
 <img src="https://img.shields.io/badge/HTML5-E34F26?style=flat-square&logo=HTML5&logoColor=white"/>
 <img src="https://img.shields.io/badge/CSS3-1572B6?style=flat-square&logo=CSS3&logoColor=white"/>
 <img src="https://img.shields.io/badge/Sass-CC6699?style=flat-square&logo=Sass&logoColor=white"/>
 <img src="https://img.shields.io/badge/styled-components-DB7093?style=flat-square&logo=styled-components&logoColor=white"/> <br/>
 <img src="https://img.shields.io/badge/JavaScript-F7DF1E?style=flat-square&logo=JavaScript&logoColor=white"/>
 <img src="https://img.shields.io/badge/React-61DAFB?style=flat-square&logo=React&logoColor=white"/>
 <img src="https://img.shields.io/badge/React-764ABC?style=flat-square&logo=Redux&logoColor=white"/>
 <img src="https://img.shields.io/badge/React-FF9900?style=flat-square&logo=AWSAmplify&logoColor=white"/>
 <img src="https://img.shields.io/badge/SOCKJS-blueviolet?style=flat-square&logoColor=white"/>
 <img src="https://img.shields.io/badge/STOMP-black?style=flat-square&logoColor=white"/>

<br/>

|라이브러리|내용|버전|
|:---:|:---:|:---:|
|Redux|전역 상태관리|4.1.2|
|Redux-thunk|리덕스 미들웨어|2.4.1|
|Redux-action|액션 관리|2.6.5|
|React-router-dom|페이지 전환|5.2.1|
|Axios|서버 통신|0.26.0|
|Sockjs-client|웹소켓 라이브러리|1.5.1|
|Stompjs|웹소켓 라이브러리|2.3.3|
|React-share|SNS 공유하기|4.4.0|
|React-copy-to-clipboard|URL 복사|5.0.4|
|moment|날짜 포맷 설정|4.1.2|
|immer|불변성 관리|4.1.2|
</div>
<br />

# ⛔️ 트러블 슈팅

## 1. 채팅방 입력 메세지 미출력 에러
<details>
  <summary>펼치기</summary>

  <div align="center">
  <img width="50%" src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/cc49ae3f-6c58-484d-9f4f-35f50ced3db7/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-03-28_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_7.34.20.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20220405%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20220405T090713Z&X-Amz-Expires=86400&X-Amz-Signature=46fa62b81c40c85b0dcf70da2b421dd9c01bd7e0703d09f6e886ae4ce9474468&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA%25202022-03-28%2520%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE%25207.34.20.png%22&x-id=GetObject"></div>
  <br/>
  저희 채팅방은 유저가 채팅방에 입장 시 위 사진처럼 입장 메세지가 나오는데<br/>
  이 입장 메세지와 함께 서버에서 어떤 아이템을 어떤 유저가 발동 중인지 정보 받아 입장 유저의 상태를 업데이트 합니다

  <br/>

  > ### 1. 에러 현상
  * 채팅방 입장시 본인은 본인의 입장 메세지를 받지 못함 (정말 간헐적으로 메세지를 출력)

  * 다른 유저들은 신규 유저의 입장 메세지를 잘 받아서 출력함

  * 입장 메세지를 수신하지 못하기 때문에, 신규 유저의 아이템 사용이 불가능

  <br/>
  
  > ### 2. 에러 해결 과정

  * 해당 에러는 DB를 변경하면서 발생하였고, 본인은 메세지를 받지 못하나 다른 유저들은 메세지를 성공적으로           수신하였습니다.<br/><br/>
    일단 정말 간헐적으로 입장 메세지가 출력되는 것을 바탕으로 생각해 봤을 때,<br/><br/>
    클라이언트에서 <b>구독 요청을 보내고 구독이 완료되기 전에 서버에서 입장 메세지를 보내주어</b> 신규 유저는 메세지를 받지 못하고,<br/>
    원래 채팅을 하던 유저들은 메세지를 정상적으로 받고 있는 것이라 생각하여<br/><br/>
    백엔드에 subscribe신호를 받고 3초 후에 메세지를 보내달라고 요청하였고.
    3초 딜레이를 주니 정상적으로 잘 메세지를 수신할 수 있었습니다.<br/><br/>

  > ### 3.해결 코드

  *  딜레이를 주면 정상적으로 작동은 하지만 사용자의 네트워크 상태에 따라 해당 딜레이 시간 동안 구독이  완료되지 않을 가능성 등 여러 가지 문제가 있고 스마트하지 못하다고 생각했습니다. <br/><br/>
    따라서 프론트에서 <b>구독요청 후 구독이 완료되었는지 검사</b> 후 구독이 완료되면 백엔드에 신호를 보내주었습니다.
      <label >
      ```javascript
      const EnterMessage = () => {
        setTimeout(() => {
          if (client.subscriptions["sub-0"]) {
            client.send(
                "/pub/chat/enter",
                headers,
                JSON.stringify({ type: "ENTER", roomId: roomId }));
            return;
          }
          EnterMessage();
        }, 100);
      };

      const connectCallback = () => {
        // 연결 성공시 호출함수
        client.subscribe(`/sub/chat/${roomId}`, subCallback, headers);
        EnterMessage();
      };
      ```
      </label>
      생각한 방법은 이러했습니다.

      연결에  성공하면 subscribe를 하고 EnterMessage메소드를 실행시킵니다.

      EnterMessage메소드 setTimeout를 이용하였고, **client의 구독 상태를 체크**하여 구독이 완료되었으면 서버에 완료 신호를 보내고,
      구독이 안되었으면 재귀 함수 형태로 다시 EnterMessage메소드를 실행시켜 주었습니다.<br/><br/>
</details>

<br/>

## 2. 모바일 토론방 이용중 홈버튼 및 화면전환시 에러 발생
<details>
  <summary>펼치기</summary>
    
서비스를 배포하고 실제 유저들이 사용중에 발견한 에러입니다😰<br/>
기존에는 컴포넌트가 언마운트 될 때, beforeunload 이벤트를 이용해 브라우저가 새로고침 될 때, 닫힐 때
disconnect신호를 서버에 전달하였으나, 모바일 환경에서 다시 문제가 발생하였습니다.

<br/>

> ### 1. 에러 현상

* 모바일 환경에서 탭 이동, 홈버튼, 화면 전환 버튼 클릭 시, 해당 채팅방이 종료될 때까지 유저가 다시 채팅방에 입장할 수 없는 심각한 오류를 발견하였습니다.

  ```javascript
  React.useEffect(() => {
    window.addEventListener("beforeunload", (e) => {
      client.disconnect(() => client.unsubscribe("sub-0"), headers);
    }); // 브라우저를 새로고침 하거나 종료하면 disconnect신호 보냄

    return () => {
      client.disconnect(() => client.unsubscribe("sub-0"), headers);
    };
  }, []);
  ```

  기존에 사용하던 disconnect코드<br/><br/>

> ### 2. 원인

* 서버에서 동일한 유저의 채팅방 다중 입장을 차단하고 있기 때문에, 탭 이동, 홈버튼, 화면 전환 버튼 클릭 시 서버
disconnect 미작동으로 인해 해당 유저가 채팅방에 남아있는걸로 인식되었습니다.<br/><br/>

> ### 3. 해결코드
* visibilitychange 이벤트를 연결해 현재 화면이 보이고 있는지 visibleHendler함수를 만들어 판단 후 disconnect신호를 서버에 보내줌

  ```javascript
  useEffect(() => {
    if (!messageLoaded) return;

    connectSocket(roomId, headers, client);
    // 메세지 로딩이 끝나면 소켓 서버에 연결

    window.addEventListener("beforeunload", (e) => {
      client.disconnect(() => client.unsubscribe("sub-0"), headers);
    }); // 브라우저를 새로고침 하거나 종료하면 disconnect신호 보냄

    const mobile = mobileCheck();
    mobile && window.addEventListener("visibilitychange", visibleHendler);
    // 모바일 환경에서 탭 전환이나 화면 전환시 disconnect신호를 보내지 못해 발생하는 오류 해결을 위해 사용

    return () => {
      client.disconnect(() => client.unsubscribe("sub-0"), headers);
      mobile && window.removeEventListener("visibilitychange", visibleHendler);
    };
  }, [messageLoaded]);

  const visibleHendler = (e) => {
    const state = document.visibilityState === "hidden"; // 화면에 안보이면

    if (state) {
      client.disconnect(() => client.unsubscribe("sub-0"), headers);
      history.replace("/");
      dispatch(
        alertAction.open({
          type: "confirm",
          message: "채팅방에 다시 입장하시겠습니까?",
          action: () => history.push("/chatroom/" + roomId),
        })
      );
    }
  };
  ```
  <br/>
</details>

<br/>

## 3. 채팅방 타이머 시간이 어긋나는 문제
<details>
  <summary>펼치기</summary>
최초 채팅방 타이머는 서버로 부터 남은 시간을 받아 setInterval을 사용해 1초씩 빼주었습니다.
하지만 이런 방식은 여러가지 문제가 발생하였습니다.

<br/>

  > ### 원인
  * setInterval이 1초마다 실행된다는 보장성이 없다.
  * alert, confirm등 브라우저가 멈추면 타이머도 멈춰 시간이 어긋난다

  <br/>

  > ### 해결
  * 일단 alert이나 confirm이 브라우저를 멈춘다면 사용하지 않으면 된다고 생각하여,<br/>직접 redux와 portal을 이용해 만들어 사용하였습니다.<br/><br/>
  그리고 서버로부터 채팅방의 종료예정시간을 받아 현재 시간과 비교하며 얼마나 남았는지 계산, useInterval커스텀 훅을 사용하여 1초마다 정보를 갱신해주었습니다.

    ```javascript
    const CountDownTimer = (props) => {
      const dispatch = useDispatch();

      const end = new Date(props.endAt.replaceAll("-", "/")); // 해당 채팅방 종료 시간
      const now = new Date(); // 현재 시간

      const [time, setTime] = useState((end - now) / 1000 + 1);

      useInterval(() => setTime((end - now) / 1000), time);

      useEffect(() => {
        if (time <= 0) {
          history.push("/");
          dispatch(
            alertAction.open({
              message: "토론이 종료되었습니다.",
            })
          );
          return;
        }
      }, [time]);

      // 분이랑 초로 변경
      const minutes = Math.floor(time / 60);
      const seconds = Math.floor(time % 60);

      return (
        <Timer restTime={time < 60 && true}>
          <Minutes>{minutes.toString().padStart(2, "0")}</Minutes> :
          <Seconds>{seconds.toString().padStart(2, "0")}</Seconds>
        </Timer>
      );
    };
    ```
    https://haekang.notion.site/setInterval-useInterval-d62a416e2db147c48ef5304de44a23f3

<br />
</details>

<br/>

# 👨‍👨‍👦‍👦 유저 피드백

>  ### 피드백 수집일자 : 2022년 3월 28일 ~ 2022년 4월 4일 <br />
>  ### 피드백 수 : 총 22개

<br />

<details>
  <summary>피드백 내용 확인</summary>

- 긍정적인 피드백
  - 채팅에서 논리로 이겨버리고 받은 포인트로 랩업해서 랭킹 1등했어요!
  - 행운뽑기 기능이 신박하고 도박요소가 있어서 재밌었습니다 ㅎㅎ 그리고 아이템 구매하는 창에서 하나씩 어떤 기능인지 설명해줘서 좋았어요 1조 분들 너무너무 고생하셨습니다.
  - DALK를 프로젝트를 준비하며, A가 좋을까 B가 더 나은 것은 아닐까. 가장 많이 고민하고 또 토론한 분들이 운영진 분들이시겠다는 생각이 들었습니다. 정말 수고 많으셨고, 앞으로 나아가실 길도 진심으로 응원하겠습니다. 모두 건강 잘 챙겨가면서 하시길 바라며.. 좋은 서비스 만들어주셔서 감사합니다🙆‍♀️
  - 아이디어 좋은거 같아요 사용자가 많아지면 더재밌게 채팅할 수있을 거같아요! 번창하시길 바랄게요!
    
    <br />

- 개선에 대한 피드백
    > 다양한 기능을 써보고 싶어도 어디에 어떤 기능이 있는지 모르겠어요. 
    
    - 사용자의 이용률과 경험만족도를 끌어올리기 위해 투표창 인식을 위한 UI 개선을 진행, <br />
    처음 방문한 사용자들을 위해 메인배너에 사용방법창으로 갈 수 있는 캐러셀을 추가

        |배너 캐러셀|투표창 초기 펼침|
        |:-:|:-:|
        |<img src ="https://user-images.githubusercontent.com/96935557/161725645-2e16ebae-b03d-4bf4-aeed-06603f7097be.png">|<img src ="https://user-images.githubusercontent.com/96935557/161725952-1705eddd-21d9-4d5b-a32d-960f4ee81f6d.png">|


        <br />
        <br />
    > 아이폰 모바일 화면은 뷰가 깨져 보여요.
    
    -  리사이즈 Event를 통해 화면크기를 실시간 계산 후 적용하는 과정을 통해서 모든 모바일 뷰 화면을 깨짐없이 개선 <br />

        ```Javascript
        const MobileFrame = ({ children }) => {
          const handleResize = () => {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty("--vh", `${vh}px`);
          };

          useEffect(() => {
            handleResize();
            window.addEventListener("resize", handleResize);

            return () => window.removeEventListener("resize", handleResize);
          }, []);

          return (
            <MobileContainer>
            <MobileWrap id="globalPortal">
                <MobileContent>{children}</MobileContent>
            </MobileWrap>
            </MobileContainer>
          );
        };
        ```

        <br />
    > 채팅방이 너무 좁아서 한눈에 토론내용을 보기 어려워요.
    - 헤더를 통합하여 채팅창을 넓게 만들어 사용자들의 불편사항 개선

        |개선 전|개선 후|
        |:-:|:-:|
        |<img src="https://user-images.githubusercontent.com/96935557/161725088-df287b72-2cd5-4724-842d-22b6ed015591.png">|<img src="https://user-images.githubusercontent.com/96935557/161725389-8c3cc822-1549-4bc2-b8bd-dfd474b7e2cf.png">|
</details>

<br />

# 🤝 후기 및 회고

<code>전해강</code> <br />
끝나지 않을 것 같았던 항해 마지막 프로젝트를 좋은 팀원분들 만나 함께 할 수 있어서 재밌었습니다..! <br />
여러분들 앞으로 하시는 일 다 잘되시고 꽃길만 걸으시길 바랍니다🌸

<code>차민재</code> <br />
실전 프로젝트를 진행하고 클린 코드의 중요성과 자바스크립트의 이해도를 높여야겠다는 생각을 했습니다. <br />
이제부터 나의 목표는 JS엔진 심장에 박기.. <br />
열심히 해준 모든 팀원들 덕분에 좋은 결과물이 나온 것 같고, 특히 저에게 도움을 많이 주셨던 해강님에게 무한의 감사를🙏

---
